---
page_id: 4882de7b-07f3-4cc8-ac01-b096e17dcc35
title: Backend API testing with Jest
description: "Guide to testing backend APIs and services using Kinde refresh tokens for maintaining long-running authenticated sessions in automated tests."
sidebar:
  order: 3
relatedArticles:
  - cc2bd7c3-b365-417f-a6d0-a2685acd6a7e
  - 5a67a5c0-3211-4d66-a090-4df8fde1cdad
  - c1b1ea81-35f9-467e-8079-042d6a786e55
topics:
  - developer-tools
  - testing
  - api-testing
  - refresh-tokens
sdk: []
languages:
  - JavaScript
  - TypeScript
  - Python
  - curl
audience: developers
complexity: intermediate
keywords:
  - backend testing
  - API testing
  - refresh tokens
  - token rotation
  - automated testing
  - CI/CD
  - test automation
updated: 2025-12-16
featured: false
deprecated: false
ai_summary: Guide to testing backend APIs using Kinde refresh tokens for maintaining authenticated sessions in automated tests, including token rotation and CI/CD integration.
---

In this guide, we'll show you how to test backend APIs using Kinde refresh tokens for maintaining authenticated sessions in automated tests, including token rotation and CI/CD integration.

### What you need

- A test user with email and password created in the [test user and environment setup](/developer-tools/testing/setup-test-user-environment/) guide.

## How it works

For automated backend tests, you can establish a long-running auth session using refresh tokens. This allows your test infrastructure to maintain authentication without manual sign-ins.

1. Perform a one-time browser-based sign-in with a test user
2. Extract the refresh token from that session
3. Store the refresh token securely (e.g., GitHub Secrets, AWS Secrets Manager)
4. Rotate tokens programmatically at the start of each test run

The access token obtained this way is identical to what your production users receive.

## Step 1: Obtain initial tokens

1. Run your test application locally
2. Sign in with your test user in a browser
3. Right click on the page and select **Inspect** to open the browser developer tools
4. Navigate to the **Application** tab and select **Cookies** > `http://localhost:3000`
5. Select the `refresh_token` and `access_token` cookies and copy their values, you will need these in the next step

    ![Screenshot of browser developer tools showing the refresh_token and access_token cookies](https://imagedelivery.net/skPPZTHzSlcslvHjesZQcQ/8f5e05a6-2671-4688-06de-bbc328b4d700/public)

## Step 2: Set up Jest testing suite

1. Install the required dependencies:

    ```bash
    npm install --save-dev jest dotenv
    ```

2. Create a new `.env` file in your project root:

    ```bash
    touch .env
    ```

3. Open the `.env` file and add your Kinde configuration:

    ```env
    # .env
    KINDE_ISSUER_URL=https://your-subdomain.kinde.com
    KINDE_CLIENT_ID=your_client_id
    KINDE_REFRESH_TOKEN=your_refresh_token_from_step_1
    KINDE_ACCESS_TOKEN=your_access_token_from_step_1
    ```

    Replace the placeholder values with your actual Kinde credentials from Step 1.

4. Create a `jest.setup.js` file:

    ```bash
    touch jest.setup.js
    ```

5. Open `jest.setup.js` and add the following code that refreshes tokens before tests run and updates the `.env` file:

    ```javascript
    // jest.setup.js
    require('dotenv').config()
    const fs = require('fs')
    const path = require('path')

    async function refreshTokens() {
      const tokenUrl = `${process.env.KINDE_ISSUER_URL}/oauth2/token`

      try {
        const response = await fetch(tokenUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            client_id: process.env.KINDE_CLIENT_ID,
            grant_type: 'refresh_token',
            refresh_token: process.env.KINDE_REFRESH_TOKEN,
          }),
        })

        if (!response.ok) {
          throw new Error(`Token refresh failed: ${response.status} ${response.statusText}`)
        }

        const tokens = await response.json()

        // Update environment variables for current test run
        process.env.KINDE_ACCESS_TOKEN = tokens.access_token
        process.env.KINDE_REFRESH_TOKEN = tokens.refresh_token

        // Update .env file for future runs
        const envPath = path.join(process.cwd(), '.env')
        let envContent = fs.readFileSync(envPath, 'utf8')

        // Replace existing tokens or add new ones
        envContent = envContent.replace(
          /KINDE_ACCESS_TOKEN=.*/,
          `KINDE_ACCESS_TOKEN=${tokens.access_token}`
        )
        envContent = envContent.replace(
          /KINDE_REFRESH_TOKEN=.*/,
          `KINDE_REFRESH_TOKEN=${tokens.refresh_token}`
        )

        fs.writeFileSync(envPath, envContent)

        console.log('✓ Tokens refreshed successfully')
      } catch (error) {
        console.warn('⚠ Failed to refresh tokens:', error.message)
        console.warn('⚠ Continuing with existing tokens from .env file')
        // Don't throw - allow tests to run with existing tokens
      }
    }

    // Refresh tokens before all tests
    // Export the promise so Jest waits for it to complete
    module.exports = refreshTokens()
    ```

6. Create or update your `package.json` file to configure Jest. Add the following to your `package.json`:

    ```json
    {
      "scripts": {
        "test": "jest"
      },
      "jest": {
        "setupFilesAfterEnv": ["<rootDir>/jest.setup.js"],
        "testEnvironment": "node"
      }
    }
    ```

7. Create a test file:

    ```bash
    touch kinde-api.test.js
    ```

8. Open `kinde-api.test.js` and add the following example tests:

    ```javascript
    // kinde-api.test.js
    require('dotenv').config()

    const KINDE_ISSUER_URL = process.env.KINDE_ISSUER_URL
    const ACCESS_TOKEN = process.env.KINDE_ACCESS_TOKEN

    describe('Kinde API Tests', () => {
      test('should get user profile', async () => {
        const response = await fetch(
          `${KINDE_ISSUER_URL}/oauth2/v2/user_profile`,
          {
            headers: {
              Authorization: `Bearer ${ACCESS_TOKEN}`,
            },
          }
        )

        expect(response.ok).toBe(true)
        const data = await response.json()
        expect(data).toHaveProperty('id')
        expect(data).toHaveProperty('email')
      })
    })
    ```

## Step 3: Update your stored token

After each token exchange:

1. Update your secret manager with the new `refresh_token`
2. Set the `access_token` as an environment variable for use in tests

**Example: jest.setup.js**

```jsx
// Example: jest.setup.js
const response = await fetch('https://your-subdomain.kinde.com/oauth2/token', {
  method: 'POST',
  headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
  body: new URLSearchParams({
    client_id: process.env.KINDE_CLIENT_ID,
    grant_type: 'refresh_token',
    refresh_token: process.env.KINDE_REFRESH_TOKEN,
  }),
});

const tokens = await response.json();
process.env.KINDE_ACCESS_TOKEN = tokens.access_token;

// Update your secret manager with tokens.refresh_token for the next run
```

## Step 4: Run the tests

to be added...

## Important considerations

### Token rotation

After exchange, the previous refresh token remains valid for approximately 30 seconds (grace period), then becomes invalid. Always use the most recently issued refresh token.

### Secure storage

Never commit tokens to source control. Use secret managers like GitHub Secrets, AWS Secrets Manager, or similar.

### Token refresh frequency

Refresh tokens at the start of each test run to ensure fresh access tokens.

## What's not supported

The following limitations apply to backend API testing with refresh tokens:

- **Social provider tokens**: Refresh tokens obtained through social sign-in may have different expiration behaviors
- **Organization-scoped tokens**: If testing organization-specific APIs, ensure your test user belongs to the correct organization
- **M2M tokens**: Machine-to-machine applications use different token mechanisms (see [M2M documentation](/machine-to-machine-applications/about-m2m/))

## Reference documentation

- [Refresh Tokens Guide](/build/tokens/refresh-tokens/)
- [Configure Tokens](/build/tokens/configure-tokens/)
- [Token Customization](/build/tokens/token-customization/)

## Best practices

1. **Isolate test environments**: Use separate Kinde environments or organizations for testing
2. **Use dedicated test users**: Don't use real user accounts for automated testing
3. **Rotate credentials regularly**: Even test credentials should follow security best practices
4. **Handle token expiry gracefully**: Build retry logic into your tests for token refresh failures
5. **Monitor test reliability**: Track flaky tests related to authentication timing issues

