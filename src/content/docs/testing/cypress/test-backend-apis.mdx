---
page_id: 6c9a5aa8-863e-4501-b357-a28f6168c29a
title: Test backend APIs
description: "Guide to testing backend APIs with Cypress using Kinde refresh tokens for maintaining long-running authenticated sessions in automated tests."
sidebar:
  order: 5
topics:
  - developer-tools
  - testing
  - cypress
  - e2e-testing
  - api-testing
sdk: []
languages:
  - JavaScript
  - TypeScript
audience: developers
complexity: intermediate
keywords:
  - cypress
  - testing
  - backend APIs
  - API testing
  - refresh tokens
updated: 2025-01-15
featured: false
deprecated: false
---

In this guide, we'll show you how to test backend APIs with Cypress. We will use Kinde refresh tokens for maintaining authenticated sessions in automated tests, including token rotation.

### What you need

- Completed the [Cypress setup](/testing/cypress/)
- A [test user and application](/testing/setup-test-user-environment/)

For guidance on how to test backend APIs with Kinde, see [Testing backend APIs](/testing/testing-backend-apis/).

## Configure Kinde refresh tokens

1. Update your `cypress.env.json` file with the `refresh token`. You can obtain the refresh token by following [this step](/testing/testing-backend-apis/#obtain-initial-access-token).

    ```json
    {
      // ...your other environment variables...
      "KINDE_REFRESH_TOKEN": "your-kinde-refresh-token",
    }
    ```

2. Create a custom command to refresh tokens:

    ```ts
    // cypress/support/commands.ts
    declare global {
      namespace Cypress {
        interface Chainable {
          refreshAccessToken(): Chainable<string>
        }
      }
    }

    Cypress.Commands.add('refreshAccessToken', () => {
      const tokenUrl = `${Cypress.env('KINDE_ISSUER_URL')}/oauth2/token`

      return cy
        .request({
          method: 'POST',
          url: tokenUrl,
          form: true,
          body: {
            grant_type: 'refresh_token',
            client_id: Cypress.env('KINDE_CLIENT_ID'),
            client_secret: Cypress.env('KINDE_CLIENT_SECRET'),
            refresh_token: Cypress.env('KINDE_REFRESH_TOKEN'),
          },
        })
        .then((response) => {
          expect(response.status).to.eq(200)
          
          // Update environment variable for current test run
          const tokens = response.body
          Cypress.env('KINDE_ACCESS_TOKEN', tokens.access_token)
          Cypress.env('KINDE_REFRESH_TOKEN', tokens.refresh_token)
          
          return tokens.access_token
        })
    })
    ```

3. Create a setup file to refresh tokens before tests run:

    ```ts
    // cypress/support/e2e.ts
    before(() => {
      // Refresh tokens before all tests
      cy.refreshAccessToken()
    })
    ```

## Create and run the tests

Here is a sample test you can run using the [Kinde test application](/testing/setup-test-user-environment/).

1. Create a test file:

    ```bash
    touch cypress/e2e/api/kinde-api.cy.ts
    ```

2. Open `kinde-api.cy.ts` and add the following example tests:

    ```ts
    // cypress/e2e/api/kinde-api.cy.ts
    describe('Kinde API Tests', () => {
      let accessToken: string

      before(() => {
        // Refresh token before all tests
        cy.refreshAccessToken().then((token) => {
          accessToken = token
        })
      })

      it('can fetch user profile', () => {
        cy.request({
          url: `${Cypress.env('KINDE_TEST_APP_URL')}/api/profile`,
          headers: {
            Authorization: `Bearer ${accessToken}`,
          },
        }).then((response) => {
          expect(response.status).to.eq(200)
          expect(response.body.email).to.eq(Cypress.env('TEST_USER_EMAIL'))
        })
      })

      it('cannot fetch user profile with invalid token', () => {
        cy.request({
          url: `${Cypress.env('KINDE_TEST_APP_URL')}/api/profile`,
          headers: {
            Authorization: `Bearer invalid-token`,
          },
          failOnStatusCode: false,
        }).then((response) => {
          expect(response.status).to.eq(401)
        })
      })

      it('can update user settings', () => {
        cy.request({
          method: 'PATCH',
          url: `${Cypress.env('KINDE_TEST_APP_URL')}/api/settings`,
          headers: {
            Authorization: `Bearer ${accessToken}`,
          },
          body: {
            theme: 'dark',
          },
        }).then((response) => {
          expect(response.status).to.eq(200)
        })
      })
    })
    ```

3. Run the tests using the following command:

    ```bash
    npx cypress open
    ```

    You should see the tests pass.

You have successfully run the tests and validated that the API is working as expected. Use this approach to test your API endpoints and ensure they are working as expected.

## CI/CD integration

For CI/CD environments, use environment variables instead of `cypress.env.json`:

```yaml
# .github/workflows/e2e-tests.yml
name: API Tests

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install dependencies
        run: npm ci
      - name: Run Cypress API tests
        run: npx cypress run --spec "cypress/e2e/api/**/*.cy.ts"
        env:
          KINDE_ISSUER_URL: ${{ secrets.KINDE_ISSUER_URL }}
          KINDE_CLIENT_ID: ${{ secrets.KINDE_CLIENT_ID }}
          KINDE_CLIENT_SECRET: ${{ secrets.KINDE_CLIENT_SECRET }}
          KINDE_REFRESH_TOKEN: ${{ secrets.KINDE_REFRESH_TOKEN }}
          KINDE_TEST_APP_URL: ${{ secrets.KINDE_TEST_APP_URL }}
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          KINDE_AUDIENCE: ${{ secrets.KINDE_AUDIENCE }}
```